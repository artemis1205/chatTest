<!DOCTYPE html>
<html>

<head>
    <title>Converse</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0">
    <link rel="stylesheet" type="text/css" href="/style.css">
    <link href='https://fonts.googleapis.com/css?family=Poiret+One' rel='stylesheet' type='text/css'>
  
</head>

<body>
    <div class="chat hue2 page">
        <h2 id='title' class="chat__heading hue2 whitet">Have a Conversation...</h2>
        <ul class="chat__message-list">
            <li class="none"></li>
        </ul>

        <div class="chat__form-container hue2">
            <form class="chat__form">
                <label for="name-input" class="visually-hidden">Name</label>
                <input id="name-input" class="chat__name-input" placeholder="Name"></input>
                <label for="message-input" class="visually-hidden">Message</label>
                <input id="message-input" class="chat__message-input" placeholder="Write a message..."></input>
                <button class="chat__submit say hue2">say</button>
            </form>
        </div>

        <div class="model">
            <li class="chat__message white huet2 box">
                <b class="chat__name"></b>
                <p class="chat__message-text"></p>
                <span class="sort none">0</span>
                <div class="chat__when"></div>
            </li>
        </div>
    </div>

    <script src="/jquery.js"></script>
    <script src="/gun.js"></script>
    <script src="/gun/nts.js"></script>
    <script>
        var gun = Gun(location.origin + '/gun');
        var chat = gun.get('converse/' + location.hash.slice(1));

        $(".chat__submit").on('click', submit);
        $(".chat_form").on('keydown', enter);
        function enter(e) {
            if (e.which !== 13) { return }
            submit(e);
        }
        function submit(e) {
            e.preventDefault();

            var msg = { when: Gun.state() };

            msg.who = $('.chat__name-input').val();
            if (!msg.who) {
                msg.who = 'user' + String.random(3);
                $('.chat__name-input').val(msg.who);
            }

            msg.what = $('.chat__message-input').val();
            if (!msg.what) { return }

            chat.set(msg);
            $('.chat__message-input').val('').focus();
        }

        chat.map().once(function (msg, id) {
            if (!msg) { return }
            var messageList = $('.chat__message-list');
            var last = sort(msg.when, messageList.children('li').last());

            var li = $("#msg-" + id)[0]; // grab if exists
            if (!li) {
                li = $('.model li').clone(true) // else create it
                    .attr('id', 'msg-' + id)
                    .insertAfter(last);
            }

            // bind the message data into the UI
            li = $(li);
            li.find('.chat__name').text(msg.who);
            li.find('.chat__message-text').text(msg.what);
            li.find('.sort').text(msg.when);

            var time = new Date(msg.when);
            li.find('.chat__when').text(time.toDateString() + ', ' + time.toLocaleTimeString());

            $('html, body').stop(true, true)
                .animate({ scrollTop: messageList.height() });
        });

        function sort(num, li) { return parseFloat(num) >= parseFloat($(li).find('.sort').text() || -Infinity) ? li : sort(num, li.prev()) }
    </script>
</body>

</html>
